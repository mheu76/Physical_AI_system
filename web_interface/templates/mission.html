{% extends "base.html" %}

{% block title %}ë¯¸ì…˜ ì œì–´ - Physical AI System{% endblock %}

{% block content %}
<div class="row">
    <!-- ë¯¸ì…˜ ì…ë ¥ ì¹´ë“œ -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-rocket"></i> ìƒˆ ë¯¸ì…˜ ì‹¤í–‰
            </div>
            <div class="card-body">
                <form id="mission-form">
                    <div class="mb-3">
                        <label for="mission-text" class="form-label">ë¯¸ì…˜ ì„¤ëª…</label>
                        <textarea class="form-control" id="mission-text" rows="3" 
                                  placeholder="ì˜ˆ: Pick up the red cup and place it on the table"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-primary w-100" id="submit-btn">
                                <i class="fas fa-play"></i> ë¯¸ì…˜ ì‹¤í–‰
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-secondary w-100" onclick="clearForm()">
                                <i class="fas fa-eraser"></i> ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- ë¹ ë¥¸ ë¯¸ì…˜ ë²„íŠ¼ë“¤ -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-bolt"></i> ë¹ ë¥¸ ë¯¸ì…˜
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="quickMission('Move to position [1, 0, 0.5]')">
                            <i class="fas fa-arrow-up"></i> ìœ„ì¹˜ ì´ë™
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="quickMission('Explore the surrounding area')">
                            <i class="fas fa-search"></i> ì£¼ë³€ íƒìƒ‰
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="quickMission('Pick up the blue object')">
                            <i class="fas fa-hand-paper"></i> ë¬¼ì²´ ì¡ê¸°
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="quickMission('Place the object on the table')">
                            <i class="fas fa-hand-holding"></i> ë¬¼ì²´ ë†“ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë¯¸ì…˜ ìƒíƒœ ì¹´ë“œ -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle"></i> í˜„ì¬ ë¯¸ì…˜ ìƒíƒœ
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>ìƒíƒœ:</strong>
                    <span id="current-mission-status" class="badge bg-secondary">ëŒ€ê¸° ì¤‘</span>
                </div>
                <div class="mb-3">
                    <strong>ì‹¤í–‰ ì‹œê°„:</strong>
                    <span id="mission-execution-time">-</span>
                </div>
                <div class="mb-3">
                    <strong>ì§„í–‰ë¥ :</strong>
                    <div class="progress">
                        <div id="mission-progress" class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>ìˆ˜í–‰ëœ ë™ì‘:</strong>
                    <span id="actions-performed">0</span>ê°œ
                </div>
                <div class="mb-3">
                    <strong>í•™ìŠµ ê°€ì¹˜:</strong>
                    <span id="learning-value">0.00</span>
                </div>
            </div>
        </div>
        
        <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-cogs"></i> ì‹œìŠ¤í…œ ìƒíƒœ
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <span class="status-indicator status-{{ 'online' if system_status.initialized else 'offline' }}"></span>
                    <span>ì‹œìŠ¤í…œ: {{ 'ì´ˆê¸°í™”ë¨' if system_status.initialized else 'ì´ˆê¸°í™” í•„ìš”' }}</span>
                </div>
                <div class="mb-2">
                    <span class="status-indicator status-{{ 'online' if system_status.learning_active else 'offline' }}"></span>
                    <span>í•™ìŠµ: {{ 'í™œì„±' if system_status.learning_active else 'ë¹„í™œì„±' }}</span>
                </div>
                <div class="mb-2">
                    <span class="status-indicator status-online"></span>
                    <span>ì•ˆì „: {{ system_status.safety_status }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì‹¤ì‹œê°„ ë¯¸ì…˜ ë¡œê·¸ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-terminal"></i> ì‹¤ì‹œê°„ ë¯¸ì…˜ ë¡œê·¸
                <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearLog()">
                    <i class="fas fa-trash"></i> ë¡œê·¸ ì§€ìš°ê¸°
                </button>
            </div>
            <div class="card-body">
                <div id="mission-log" class="bg-dark text-light p-3" style="height: 300px; overflow-y: auto; font-family: monospace;">
                    <div class="text-muted">ë¯¸ì…˜ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ë¯¸ì…˜ íˆìŠ¤í† ë¦¬ í…Œì´ë¸” -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-history"></i> ë¯¸ì…˜ íˆìŠ¤í† ë¦¬
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ë¯¸ì…˜</th>
                                <th>ìƒíƒœ</th>
                                <th>ì‹¤í–‰ ì‹œê°„</th>
                                <th>ë™ì‘ ìˆ˜</th>
                                <th>í•™ìŠµ ê°€ì¹˜</th>
                                <th>íƒ€ì„ìŠ¤íƒ¬í”„</th>
                            </tr>
                        </thead>
                        <tbody id="mission-history-table">
                            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentMissionId = null;
let missionStartTime = null;

// ë¯¸ì…˜ í¼ ì œì¶œ
document.getElementById('mission-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const missionText = document.getElementById('mission-text').value.trim();
    if (!missionText) {
        showNotification('ë¯¸ì…˜ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    executeMission(missionText);
});

// ë¯¸ì…˜ ì‹¤í–‰
function executeMission(missionText) {
    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<div class="loading"></div> ì‹¤í–‰ ì¤‘...';
    
    // ë¯¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateMissionStatus('ì‹¤í–‰ ì¤‘', 'warning');
    missionStartTime = Date.now();
    
    // ë¡œê·¸ì— ë¯¸ì…˜ ì‹œì‘ ê¸°ë¡
    addLogEntry(`ğŸš€ ë¯¸ì…˜ ì‹œì‘: ${missionText}`, 'info');
    
    fetch('/api/missions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ mission: missionText })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('ë¯¸ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            addLogEntry('âœ… ë¯¸ì…˜ì´ ì„œë²„ì—ì„œ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...', 'success');
        } else {
            showNotification('ë¯¸ì…˜ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message, 'danger');
            addLogEntry('âŒ ë¯¸ì…˜ ì‹œì‘ ì‹¤íŒ¨: ' + data.message, 'error');
            updateMissionStatus('ì‹¤íŒ¨', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('ë¯¸ì…˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
        addLogEntry('âŒ ë¯¸ì…˜ ì‹¤í–‰ ì˜¤ë¥˜: ' + error.message, 'error');
        updateMissionStatus('ì˜¤ë¥˜', 'danger');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// ë¹ ë¥¸ ë¯¸ì…˜ ì‹¤í–‰
function quickMission(missionText) {
    document.getElementById('mission-text').value = missionText;
    executeMission(missionText);
}

// í¼ ì´ˆê¸°í™”
function clearForm() {
    document.getElementById('mission-text').value = '';
    updateMissionStatus('ëŒ€ê¸° ì¤‘', 'secondary');
    document.getElementById('mission-execution-time').textContent = '-';
    document.getElementById('mission-progress').style.width = '0%';
    document.getElementById('actions-performed').textContent = '0';
    document.getElementById('learning-value').textContent = '0.00';
}

// ë¯¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateMissionStatus(status, type) {
    const statusElement = document.getElementById('current-mission-status');
    statusElement.textContent = status;
    statusElement.className = `badge bg-${type}`;
}

// ë¡œê·¸ì— í•­ëª© ì¶”ê°€
function addLogEntry(message, type = 'info') {
    const logContainer = document.getElementById('mission-log');
    const timestamp = new Date().toLocaleTimeString('ko-KR');
    
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${type}`;
    logEntry.innerHTML = `[${timestamp}] ${message}`;
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
    
    // ìµœëŒ€ 100ê°œ ë¡œê·¸ í•­ëª©ë§Œ ìœ ì§€
    const entries = logContainer.querySelectorAll('.log-entry');
    if (entries.length > 100) {
        entries[0].remove();
    }
}

// ë¡œê·¸ ì§€ìš°ê¸°
function clearLog() {
    const logContainer = document.getElementById('mission-log');
    logContainer.innerHTML = '<div class="text-muted">ë¯¸ì…˜ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>';
}

// ë¯¸ì…˜ íˆìŠ¤í† ë¦¬ í…Œì´ë¸” ì—…ë°ì´íŠ¸
function updateMissionHistory() {
    fetch('/api/missions')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const tbody = document.getElementById('mission-history-table');
                tbody.innerHTML = '';
                
                data.data.forEach(mission => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${mission.id}</td>
                        <td>${mission.mission}</td>
                        <td><span class="badge bg-${mission.status === 'success' ? 'success' : 'danger'}">${mission.status}</span></td>
                        <td>${mission.execution_time.toFixed(2)}ì´ˆ</td>
                        <td>${mission.actions_count}</td>
                        <td>${mission.learning_value.toFixed(2)}</td>
                        <td>${new Date(mission.timestamp).toLocaleString('ko-KR')}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        });
}

// Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
socket.on('mission_completed', function(data) {
    const executionTime = (Date.now() - missionStartTime) / 1000;
    
    addLogEntry(`âœ… ë¯¸ì…˜ ì™„ë£Œ! ì‹¤í–‰ ì‹œê°„: ${executionTime.toFixed(2)}ì´ˆ`, 'success');
    addLogEntry(`ğŸ“Š ìˆ˜í–‰ëœ ë™ì‘: ${data.actions_count}ê°œ`, 'info');
    addLogEntry(`ğŸ§  í•™ìŠµ ê°€ì¹˜: ${data.learning_value.toFixed(2)}`, 'info');
    
    updateMissionStatus('ì™„ë£Œ', 'success');
    document.getElementById('mission-execution-time').textContent = `${data.execution_time.toFixed(2)}ì´ˆ`;
    document.getElementById('mission-progress').style.width = '100%';
    document.getElementById('actions-performed').textContent = data.actions_count;
    document.getElementById('learning-value').textContent = data.learning_value.toFixed(2);
    
    // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
    updateMissionHistory();
    
    showNotification(`ë¯¸ì…˜ ì™„ë£Œ: ${data.mission}`, 'success');
});

socket.on('mission_error', function(data) {
    addLogEntry(`âŒ ë¯¸ì…˜ ì˜¤ë¥˜: ${data.error}`, 'error');
    updateMissionStatus('ì˜¤ë¥˜', 'danger');
    showNotification('ë¯¸ì…˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    updateMissionHistory();
    
    // ì£¼ê¸°ì ìœ¼ë¡œ íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
    setInterval(updateMissionHistory, 10000);
});
</script>

<style>
.log-entry {
    margin-bottom: 5px;
    padding: 2px 0;
}

.log-info {
    color: #17a2b8;
}

.log-success {
    color: #28a745;
}

.log-warning {
    color: #ffc107;
}

.log-error {
    color: #dc3545;
}

#mission-log {
    font-size: 0.9rem;
    line-height: 1.4;
}
</style>
{% endblock %}
